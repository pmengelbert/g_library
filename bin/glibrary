#!/usr/bin/env ruby
require 'json'
require 'io/console'

require_relative '../modules/api_query'
require_relative '../modules/command_line_parse'
require_relative '../modules/errors'
require_relative '../modules/error_handler'
require_relative '../modules/exec_helper'
require_relative '../modules/google_api_url'
require_relative '../modules/user_prompt'

require_relative '../lib/book_search'
require_relative '../lib/user_book'
require_relative '../lib/user_library'

include ExecHelper
include UserPrompt
include CommandLineParse
include ErrorHandler

CURRENT_DIR = File.join(File.dirname(__FILE__))
DEFAULT_FILENAME =  File.join( File.expand_path("..", CURRENT_DIR), 
  "saved_libraries", "library.json" )

process_args!

@options = {}
@filename = DEFAULT_FILENAME
command_line_parse! #this function processes @filename and fills the @options hash.

prepare_filename_for_os!

if library_mode?

  with_library_mode_error_handling do
    (@library = UserLibrary.new(filename: @filename)).pretty_print
    library_mode_user_prompt
  end

else

  with_search_mode_error_handling do
    @persistent_library = UserLibrary.new(filename: @filename)
    @temp_booklist = UserLibrary.new(nonpersistent: true)

    search_results = perform_search
    search_results.selected_results.each { |info| @temp_booklist.add(UserBook.new(info)) }
    @temp_booklist.pretty_print

    search_mode_user_prompt
  end

end
