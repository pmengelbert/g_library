#!/usr/bin/env ruby
require 'json'
require 'io/console'

require_relative '../common/api_query'
require_relative '../common/command_line_parse'
require_relative '../common/errors'
require_relative '../common/exec_helper'
require_relative '../common/google_api_url'
require_relative '../common/user_prompt'

require_relative '../classes/book_search'
require_relative '../classes/user_book'
require_relative '../classes/user_library'

include ExecHelper
include UserPrompt
include CommandLineParse

CURRENT_DIR = File.join(File.dirname(__FILE__))
DEFAULT_FILENAME =  "../saved_libraries/library.json"

ExecHelper::process_args!

options = {}
filename = File.join(CURRENT_DIR, DEFAULT_FILENAME)
filename, options = CommandLineParse::command_line_parse!(filename, options)

ExecHelper::prepare_filename_for_os!(filename)

persistent_library = UserLibrary.new(filename)

temp_booklist = UserLibrary.new("", nonpersistent: true)

begin
  search_results = ExecHelper::perform_search(options)
  search_results.selected_results.each { |info| temp_booklist.add(UserBook.new(info)) }

  temp_booklist.pretty_print

  UserPrompt::search_user_prompt(temp_booklist, persistent_library)

rescue UserQuits
  puts "\nThanks for browsing.  Nothing has been added to the reading list."
rescue NoInternetError
  puts "\nNo internet connection.  Please connect to the internet and try again."
  puts ""
rescue SearchError 
  puts "\nThere was an error with your query; be careful to format it well"
  puts ""
rescue NoResults
  puts "\nNo results."
  puts ""
end
exit
