#!/usr/bin/env ruby
require 'json'
require 'io/console'

require_relative '../common/api_query'
require_relative '../common/command_line_parse'
require_relative '../common/errors'
require_relative '../common/exec_helper'
require_relative '../common/google_api_url'
require_relative '../common/search_error'

require_relative '../classes/book_search'
require_relative '../classes/user_book'
require_relative '../classes/user_library'

CURRENT_DIR = File.join(File.dirname(__FILE__))
DEFAULT_FILENAME =  "../saved_libraries/library.json"

process_args!

options = {}
filename = File.join(CURRENT_DIR, DEFAULT_FILENAME)
filename, options = command_line_parse!(filename, options)

prepare_filename_for_os!(filename)

l = UserLibrary.new(filename)

begin
  s = perform_search(options)

  books = s.map { |info| UserBook.new(info) }

  print_book_results(books)
  i = get_book_number

  l << books[i]
  l.save
rescue NoInternetError
  puts "\nNo internet connection.  Please connect to the internet and try again."
  puts ""
rescue SearchError 
  puts "\nThere was an error with your query; be careful to format it well"
  puts ""
  exit
rescue NoResults
  puts "\nNo results."
  puts ""
  exit
end
